
\input{preamble.tex}

\begin{document}

    \maketitle

    \begin{frame}{Plan}
        \tableofcontents%[hideallsubsections]
    \end{frame}

    \section{Le jeu du Sokoban}
        \begin{frame}{Le jeu du Sokoban}
            \begin{columns}
                \begin{column}{0.3\textwidth}
                    \begin{figure}
                        \centering
                        \includegraphics[width=\columnwidth]{creator.jpg}
                        \caption*{Hiroyuki Imabayashi}
                    \end{figure}
                \end{column}
                \begin{column}{0.7\textwidth}
                    \begin{figure}
                        \centering
                        \includegraphics[width=\columnwidth]{level_example.png}
                        \caption*{\textit{XSokoban}}
                    \end{figure}
                \end{column}
            \end{columns}
        \end{frame}

        \begin{frame}{Règles}

            \begin{columns}
                \begin{column}{0.5\textwidth}
                    \only<1-2>{
                        \begin{figure}
                            \centering
                            \begin{tikzpicture}
                            \node[anchor=south west, inner sep=0] (image) at (0,0) {\includegraphics[width=0.9\textwidth]{rules/moves.png}};
                        \end{tikzpicture}
                            \caption*{Déplacements autorisés}
                        \end{figure}
                    }
                    \only<3>{
                        \begin{figure}
                            \centering
                            \includegraphics{rules/move_no_1.png}
                            \caption*{\includegraphics[width=\iconwidth]{icons/no.png}}
                        \end{figure}
                    }
                \end{column}
                \begin{column}{0.5\textwidth}
                    \only<2>{
                        \begin{figure}
                            \centering
                            \includegraphics{rules/move_yes.png}
                            \caption*{\includegraphics[width=\iconwidth]{icons/yes.png}}
                        \end{figure}
                    }
                    \only<3>{
                        \begin{figure}
                            \centering
                            \includegraphics{rules/move_no_2.png}
                            \caption*{\includegraphics[width=\iconwidth]{icons/no.png}}
                        \end{figure}
                    }
                \end{column}
            \end{columns}
        \end{frame}

        \begin{frame}{But du jeu}
            \centering
            \begin{columns}
                \begin{column}{0.5\textwidth}
                    \includegraphics[width=\columnwidth]{rules/last_move.png}
                \end{column}
                \begin{column}{0.5\textwidth}
                    \includegraphics[width=\columnwidth]{rules/end.png}
                \end{column}
            \end{columns}
        \end{frame}

        \begin{frame}{Lien avec le thème de l'année}
            \centering
            \only<1>{\includegraphics[width=0.9\textwidth]{warehouse.jpg}}
            \only<2>{\includegraphics[width=0.9\textwidth]{city_plan.jpg}}
        \end{frame}

    \section{Principe de résolution}
            \begin{frame}{Arbre des états}
                \begin{customtree}
                    \input{content/states_tree.tex}
                \end{customtree}
            \end{frame}

            \begin{frame}{Exemple développé}
                \begin{customtree}
                    \input{content/exhaustive_tree.tex}

                    % Put it but not draw it to have the same width on the next slide
                    \node(c22)[ellipse, minimum width=4.2cm, minimum height=3.2cm, line width=1mm, red] at (sameState22.center){};
                \end{customtree}
            \end{frame}

            \begin{frame}{Un graphe vu comme un arbre}
                \begin{customtree}
                    \input{content/exhaustive_tree.tex}

                    \node(c1)[draw, ellipse, minimum width=4.2cm, minimum height=3.2cm, line width=1mm, red] at (sameState1.center){};
                    \node(c2)[draw, ellipse, minimum width=4.2cm, minimum height=3.2cm, line width=1mm, red] at (sameState2.center){};
                    \node(c12)[draw, ellipse, minimum width=4.2cm, minimum height=3.2cm, line width=1mm, red] at (sameState12.center){};
                    \node(c22)[draw, ellipse, minimum width=4.2cm, minimum height=3.2cm, line width=1mm, red] at (sameState22.center){};

                    \draw[<->, draw=red, line width = 2mm] (c1.north) |- (c12.west);
                    \draw[<->, draw=red, line width = 2mm] (c2.east) -| (c22.south);
                \end{customtree}
            \end{frame}

            \begin{frame}{Hash de Zobrist}
                Initialisation:

                \begin{center}
                    $T=\begin{blockarray}{ccc}
                            \text{caisse} & \text{joueur} & \text{case} \\
                        \begin{block}{(cc)c}
                            6357   & 5742   & 0      \\
                            -1378  & 42     & 1      \\
                            \vdots & \vdots & \vdots \\
                            93268  & -278   & wh - 1 \\
                        \end{block}
                    \end{blockarray}$
                \end{center}

                Usage:
                $(c_1, ..., c_n)$ $n$ caisses et $p$ position du joueur:
                $h = \underset{i=0}{\overset{n}{\xor}} T[c_i][0] \xor T[p][1]$

                Passer d'une configuration à une autre:
                $c_i \rightarrow c_i', p \rightarrow p'$
                $h = h \xor T[c_i][0] \xor T[c_i'][0] \xor T[p][1] \xor T[p'][1]$
            \end{frame}

    \section{Réduction de l'espace de recherche}

        \subsection{Analyse statique}

            \begin{frame}{Détection des positions mortes \textit{(dead positions)}}
                \centering
                \only<1>{
                    \begin{tikzpicture}
                        \node(before){\includegraphics{dead_positions/example_before.png}};
                        \node(after)[right=of before]{\includegraphics{dead_positions/example_after.png}};
                        \draw[->, line width=\arrowwidth] (before) -- (after);
                    \end{tikzpicture}
                }
                \only<2-> {
                    \begin{enumerate}
                        \only<2>{
                            \item
                                \begin{tikzpicture}[baseline]
                                    \node(first){\includegraphics{dead_positions/algo_1_1.png}};
                                    \node(second)[right=of first]{\includegraphics{dead_positions/algo_1_2.png}};
                                    \draw[->, line width=\arrowwidth] (before) -- (after);
                                \end{tikzpicture}
                        }
                        \only<3->{
                            \setcounter{enumi}{1}
                            \item
                                \begin{tikzpicture}[baseline, every node/.style={node distance=0.1cm}]
                                    \node(first){\includegraphics{dead_positions/algo_2_1.png}};
                                    \node(second)[right=of first, visible on=<4>]{$\dots$};
                                    \node[right=of second, visible on=<4>]{\includegraphics{dead_positions/algo_2_2.png}};
                                \end{tikzpicture}
                        }
                    \end{enumerate}
                }
            \end{frame}

            \begin{frame}{Détection de tunnels}
                \only<1>{
                    \includegraphics[width=\textwidth]{tunnels/tunnels.png}
                }
                \only<2>{
                    \begin{center}
                        \includegraphics[width=0.6\textwidth]{tunnels/tunnel_macro_one_crate_1.png}

                        \includegraphics[width=0.6\textwidth]{tunnels/tunnel_macro_one_crate_2.png}
                    \end{center}
                }
                \only<3>{
                     \includegraphics[width=\textwidth]{tunnels/tunnel_macro.png}
                }
                \only<4>{
                    \includegraphics[width=\textwidth]{tunnels/tunnel_macro_player_only.png}
                }
                \only<5>{
                    \includegraphics[width=\textwidth]{tunnels/tunnel_macro_oneway.png}
                }
                \only<6>{
                    \begin{minipage}{0.4\textwidth}
                         \includegraphics[width=\textwidth]{tunnels/straight.png}
                    \end{minipage}
                    \hfill
                    \begin{minipage}{0.4\textwidth}
                         \includegraphics[width=\textwidth]{tunnels/corner.png}
                    \end{minipage}
                }
            \end{frame}

            \begin{frame}{Salles et ordre de rangement \textit{(packing order)}}
                \only<1>{
                    \includegraphics[width=\textwidth]{rooms_packing_order/rooms.png}
                }
                \only<2>{
                    \includegraphics[width=\textwidth]{rooms_packing_order/level_completed.png}
                }
                \only<3>{
                    \includegraphics[width=\textwidth]{rooms_packing_order/packing_order.png}
                }
                \only<4>{
                    \centering
                    \includegraphics[height=0.8\textheight]{rooms_packing_order/no_packing_order.png}
                }
            \end{frame}

        \subsection{Analyse dynamique}

            \begin{frame}{Détection d'impasses \textit{(deadlocks)}}
                \begin{figure}
                    \centering
                    \subcaptionbox{\textit{Freeze deadlock n°1}} {
                        \includegraphics[width=0.4\textwidth]{freeze_deadlock/ex_1_dead.png}
                    }
                    \subcaptionbox{\textit{Freeze deadlock n°2}} {
                        \includegraphics[width=0.4\textwidth]{freeze_deadlock/ex_2_dead.png}
                    }
                    \subcaptionbox{\textit{PI Corral deadlock}} {
                        \includegraphics[width=0.4\textwidth]{pi_corral_deadlock_dead.png}
                    }
                \end{figure}
            \end{frame}

            \begin{frame}{Détection de \textit{freeze deadlocks}}
                \begin{figure}
                    \subcaptionbox{\textit{Règle n°1}} {
                        \includegraphics[width=0.3\textwidth]{freeze_deadlock/rule_1.png}
                    }
                    \subcaptionbox{\textit{Règle n°2}} {
                        \includegraphics[width=0.3\textwidth]{freeze_deadlock/rule_2.png}
                    }
                    \subcaptionbox{\textit{Règle n°3}} {
                        \includegraphics[width=0.3\textwidth]{freeze_deadlock/rule_3.png}
                    }
                \end{figure}
            \end{frame}

            \begin{frame}{Détection de \textit{freeze deadlocks}}
                \centering
                \begin{tikzpicture}
                    \node (start) {
                        \includegraphics[width=0.4\textwidth]{freeze_deadlock/ex_2_dead.png}
                    };
                    \node[visible on=<2-4>, right=of start] (first) {
                        \includegraphics[width=0.4\textwidth]{freeze_deadlock/ex_2_explanation_1.png}
                    };
                    \node[visible on=<3-4>, below=of first] (second) {
                        \includegraphics[width=0.4\textwidth]{freeze_deadlock/ex_2_explanation_2.png}
                    };
                    \node[visible on=<4>, left=of second] (third) {
                        \includegraphics[width=0.4\textwidth]{freeze_deadlock/ex_2_explanation_3.png}
                    };
                    % don't remove '0cm', otherwise tikz will place the text too below
                    \node [visible on=<4>, below=0cm of third.south] {Gelée!};

                    \draw[->, line width=\arrowwidth, visible on=<2-4>] (start.east)  -- (first.west);
                    \draw[->, line width=\arrowwidth, visible on=<3-4>] (first.south) -- (second.north);
                    \draw[->, line width=\arrowwidth, visible on=<4>] (second.west) -- (third.east);
                \end{tikzpicture}
            \end{frame}
            \begin{frame}{Détection de \textit{PI Corral deadlocks}}
                \only<1> {
                    \begin{figure}
                        \centering
                        \subcaptionbox{\textit{Corral}} {
                            \includegraphics[width=0.4\textwidth]{corral/corral.png}
                        }
                        \subcaptionbox{\textit{I Corral}} {
                            \includegraphics[width=0.4\textwidth]{corral/i_corral.png}
                        }
                        \subcaptionbox{\textit{PI Corral}} {
                            \includegraphics[width=0.4\textwidth]{corral/pi_corral.png}
                        }
                    \end{figure}
                }
                \only<2>{
                    \begin{minipage}{0.45\textwidth}
                        \includegraphics[width=\textwidth]{corral/multi_pi_corral_1.png}
                    \end{minipage}
                    \begin{minipage}{0.45\textwidth}
                        \includegraphics[width=\textwidth]{corral/multi_pi_corral_2.png}
                    \end{minipage}
                }
            \end{frame}
            \begin{frame}{Table de \textit{deadlocks}}
                \only<1>{
                    \begin{minipage}{0.45\textwidth}
                         \includegraphics[width=\textwidth]{deadlock_table/init.png}
                    \end{minipage}
                    \begin{minipage}{0.45\textwidth}
                        \includegraphics[width=\textwidth]{deadlock_table/new_deadlock.png}
                    \end{minipage}
                }
                \only<2>{
                    \input{content/deadlock_table_tree.tex}
                }
            \end{frame}

    \section{Recherche dirigée par une heuristique}
        \begin{frame}{Heuristique simple \textit{(Simple Lower Bound)}}

            \only<1>{

            }
        \end{frame}

        \begin{frame}{Heuristique gloutonne \textit{(Greedy Lower Bound)}}
        \end{frame}

    \section{Optimisations}
        \begin{frame}{Parcours de graphes: démarquer tous les noeuds en $\mathcal{O}(1)$}
            \begin{tikzpicture}
                \node (start) {
                    \includegraphics[width=0.15\textwidth]{optimisations/mark_init.png}
                };
                \node[right=of start] (first) {
                    \includegraphics[width=0.15\textwidth]{optimisations/mark_player.png}
                };
                \node[right=of first] (second) {
                    \includegraphics[width=0.15\textwidth]{optimisations/mark_all.png}
                };
                \node[right=of second] (third) {
                    \includegraphics[width=0.15\textwidth]{optimisations/unmark.png}
                };
                % don't remove '0cm', otherwise tikz will place the text too below
                \node [below=0cm of start.south] {$m=0$};
                \node [below=0cm of first.south] {$m=0$};
                \node [below=0cm of second.south] {$m=0$};
                \node [below=0cm of third.south] {$m=1$};

                \draw[->, line width=\arrowwidth] (start.east)  -- (first.west);
                \draw[->, line width=\arrowwidth, dashed] (first.east) -- (second.west);
                \draw[->, line width=\arrowwidth] (second.east) -- (third.west);
            \end{tikzpicture}
        \end{frame}

        \input{content/greedy_heuristic.tex}

        \begin{frame}{Calcul des \textit{corrals} en $\mathcal{O}(wh)$}
            \only<1>{
                Utilisation de \textit{Union-Find}: partition de $\llbracket 0;wh-1 \rrbracket$.

                \centering
                \includegraphics[width=0.7\textwidth]{corral_detection/corral.png}
            }
            \only<2>{
                \begin{algorithm}[H]
                    \begin{algorithmic}[1]
                        \Procedure{corral}{$x,y$}
                            \If{not solid(x,y)}
                                \State createSingleton(x, y)
                            \Else
                                \If{solid(x-1, y) \textbf{and} solid(x,y-1)}
                                    \State createSingleton(x, y)
                                \ElsIf{not solid(x-1, y) \textbf{and} solid(x,y-1)}
                                    \State addToCorral(x-1,y, x,y)
                                \ElsIf{solid(x-1, y) \textbf{and} not solid(x,y-1)}
                                    \State addToCorral(x,y-1, x,y)
                                \Else
                                    \State addToCorral(x-1,y, x,y)
                                    \State union(x,y-1, x,y)
                                \EndIf
                            \EndIf
                        \EndProcedure
                    \end{algorithmic}
                \end{algorithm}
            }
        \end{frame}
    \section{Résultats}


    \section{Annexe}
        \begin{frame}{Tableau des compléxités}

        \end{frame}
\end{document}
